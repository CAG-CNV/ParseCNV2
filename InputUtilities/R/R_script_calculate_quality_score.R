# TODO: Add comment
# 
# Author: amarce
###############################################################################

################################################################################################################################################################################################################################
#  Write text for the command windows
################################################################################################################################################################################################################################
print('R - start to calculate the Quality Score')

################################################################################################################################################################################################################################
#  Clean workspace
################################################################################################################################################################################################################################
rm(list = ls())

################################################################################################################################################################################################################################
# Load libraries
################################################################################################################################################################################################################################

################################################################################################################################################################################################################################
# Define function
################################################################################################################################################################################################################################
calculate_QS <- function(cnv_data, model_data){
    #print(cnv_data);print(model_data)
    QS_val <- rep(model_data['(Intercept)', 'Estimate'], nrow(cnv_data))
    for(para in 2:nrow(model_data)){
        para_name   <- rownames(model_data)[para]
        QS_val      <- QS_val + model_data[para_name, 'Estimate'] * scale(cnv_data[, para_name])
    }
    #print(QS_val)
    QS_val  <- 1 / (1 + exp(-QS_val))
    return(QS_val)
}

################################################################################################################################################################################################################################
#  Load the directory path information
################################################################################################################################################################################################################################
args               <- commandArgs(TRUE)
tmp_dir_path       <- args[1]


################################################################################################################################################################################################################################
#  Load the CNV data, and create separate variable for the del and dup
################################################################################################################################################################################################################################
load(file = paste(tmp_dir_path, 'cnv_data_global.rdata', sep = '/'))
    
cnv_data_global_del <- subset(cnv_data_global, subset = Copy_Number < 2)
cnv_data_global_dup <- subset(cnv_data_global, subset = Copy_Number > 2)
#print(cnv_data_global_del)
################################################################################################################################################################################################################################
#  define the QS coefficients
################################################################################################################################################################################################################################
QS_coefficient_duplication              <- cbind(c(-0.81529185, 3.90248885, -0.90184846, 0.34376765, -0.06351849, -0.01497046, -0.30665878, -0.10354156, -0.44829901, 0.06039380, 0.03645913), rep(0, 11))
rownames(QS_coefficient_duplication)    <- c('(Intercept)', 'Max_Log_BF', 'No_Probes', 'LRR_SD', 'BAF_drift', 'WF', 'LRR_mean', 'NumCNV', 'BAF_SD', 'Length_bp', 'BAF_mean')
colnames(QS_coefficient_duplication)    <- c('Estimate', 'Pr(>|z|)')

QS_coefficient_deletion             <- cbind(c(-1.75648377, 4.64898485, -2.50150285, -0.47552224, 0.28876320, 0.10205302, 0.14363692, 0.02959571, 0.00000000, -0.00000000), rep(0, 10))
rownames(QS_coefficient_deletion)   <- c('(Intercept)', 'Max_Log_BF', 'No_Probes', 'NumCNV', 'LRR_SD', 'Length_bp', 'LRR_mean', 'WF', 'BAF_drift', 'BAF_SD')
colnames(QS_coefficient_deletion)   <- c('Estimate', 'Pr(>|z|)')

################################################################################################################################################################################################################################
#  Calculate the Quality Score
################################################################################################################################################################################################################################
QS_deletion     <- calculate_QS(cnv_data = cnv_data_global_del, model_data = QS_coefficient_deletion)
QS_duplication  <- calculate_QS(cnv_data = cnv_data_global_dup, model_data = QS_coefficient_duplication)
#print(QS_deletion)
#print(QS_duplication)
################################################################################################################################################################################################################################
#  Calculate the Quality Score
################################################################################################################################################################################################################################
QS                                          <- matrix(NA, nrow = nrow(cnv_data_global), ncol = 1)
QS[which(cnv_data_global$Copy_Number < 2),] <- QS_deletion * -1
QS[which(cnv_data_global$Copy_Number > 2),] <- QS_duplication
colnames(QS)                                <- c('Quality_Score')

cnv_data_global    <- cbind(cnv_data_global, QS)

################################################################################################################################################################################################################################
#  Save the new CNV dataset with the Quality Score the deletion and duplication
################################################################################################################################################################################################################################
save(cnv_data_global, file = paste(tmp_dir_path, 'cnv_data_global.rdata', sep = '/'))
#write.table(summary(cnv_data_global)[,-1], file = paste(gsub('/R', '', tmp_dir_path), 'log_CNV_summary_dataframe.txt', sep = '/'), quote = FALSE)
write.table(cnv_data_global, file = paste(substr(tmp_dir_path, 1, nchar(tmp_dir_path) - 2), 'log_CNV_summary_dataframe.txt', sep = '/'), quote = FALSE, row.names = FALSE)

QS_histogram <- hist(cnv_data_global$Quality_Score, breaks = 20, plot = FALSE)
#save(QS_histogram, file = paste(gsub('/R', '', tmp_dir_path), 'log_Quality_Score_histogram.rdata', sep = '/'))
#save(QS_histogram, file = paste(substr(tmp_dir_path, 1, nchar(tmp_dir_path) - 2), 'log_Quality_Score_histogram.rdata', sep = '/'))

################################################################################################################################################################################################################################
#  Write text for the command windows
################################################################################################################################################################################################################################
print('R - finish to calculate the Quality Score')


















